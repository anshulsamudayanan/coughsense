<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cough Detector AI</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f7f9; padding: 20px; max-width: 700px; margin: auto; }
  h1 { margin-bottom: 8px; }
  .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 12px; }
  button { padding: 10px 16px; border-radius: 8px; font-size: 15px; cursor: pointer; margin-right: 8px; }
  button[disabled] { opacity: 0.6; cursor: not-allowed; }
  #status { margin-top: 12px; font-weight: bold; font-size: 18px; }
</style>

<!-- Teachable Machine Audio library -->
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8/dist/teachablemachine-audio.min.js"></script>
</head>
<body>

<h1>ü©∫ Cough Detector AI</h1>
<div class="card">
  <div>Click <b>Start</b> to allow the microphone and detect cough sounds.</div>
  <button id="startBtn">‚ñ∂ Start</button>
  <button id="stopBtn" disabled>‚èπ Stop</button>
  <div id="status">Result: Not Listening</div>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/VvsXNYSYW/"; // must be in quotes

let model = null;
let listening = false;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");

async function loadModel() {
  const modelURL = MODEL_URL + "model.json";
  const metadataURL = MODEL_URL + "metadata.json";
  model = await tmAudio.load(modelURL, metadataURL);
  console.log("Model loaded");
}

// Function to start microphone and listening
async function startListening() {
  if (!model) await loadModel();

  try {
    // ‚úÖ Ask for microphone access
    await navigator.mediaDevices.getUserMedia({ audio: true });

    // Start Teachable Machine listening
    await model.listen(predictions => {
      // predictions is an array of {className, probability}
      const coughPreds = predictions.filter(p => p.className.startsWith("Cough"));
      const coughSum = coughPreds.reduce((sum, p) => sum + p.probability, 0);

      let topCough = coughPreds.reduce((best, p) => p.probability > (best?.probability || 0) ? p : best, null);

      if (coughSum > 0.6) {
        statusEl.textContent = `Result: COUGH (${topCough.className})`;
      } else {
        statusEl.textContent = "Result: NOT COUGH";
      }
    }, {
      probabilityThreshold: 0,
      overlapFactor: 0.5
    });

    listening = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    statusEl.textContent = "Listening...";
  } catch (err) {
    console.error("Mic access denied or not working", err);
    statusEl.textContent = "Microphone access denied!";
  }
}

// Stop listening
async function stopListening() {
  if (model && listening) {
    await model.stopListening();
    listening = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    statusEl.textContent = "Stopped listening";
  }
}

startBtn.addEventListener("click", startListening);
stopBtn.addEventListener("click", stopListening);
</script>

</body>
</html>
